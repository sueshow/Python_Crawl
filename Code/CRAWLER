from selenium import webdriver
from selenium.webdriver.common.by import By

import os, time
import random
import json

min_time = 2
max_time = 4
delimiter = ','

url = 'https://addr.tgos.tw/addrws/v30/QueryAddr.asmx?op=QueryAddr'
browser = webdriver.Chrome(executable_path=r'D:\WebDrivers\chromedriver.exe')
browser.get(url)
time.sleep(random.randint(min_time, max_time) + abs(random.random()))

md5 = '123'
oAddress = '地址'

oAPPId = '7hufInjKgWC/0SEjPtgbdfhkpOErncNIGM12pnvKpc6WazhCkw+yRQ=='
oAPIKey = 'cGEErDNy5yNr14zbsE/4GSfiGP5i3PuZEyzKB40F6S9SU2dEBwURtLsacnvzKOYpmGQKCxgmk+/DcWjmFcMOls3b957bAyU/rto+RbxUHClXNNfiA8/Kb4Q5NGznHj/l52xilHITBaVbopcJ+FMkzqG5C0J489Kw2Bs+ekVr1EN9ArybXcod8zLgiSI6W95OvDu/phHcSeOX5sRlVwu8zHRdSsYphinhegEikLdWqDTtyMQc5G2ogw6t8w70FtbGrliEGFTTsKQfIibMwUJBFdrVzcqSTtWjZcy3JFVsEpuBo0cdqw7T2+r8vaOTimR/XRNaywVGiFc='
oSRS = 'EPSG:4326',
oFuzzyType = '2',
oResultDataType = 'json',
oFuzzyBuffer = '0',
oIsOnlyFullMatch = 'false',
oIsLockCounty = 'false',
oIsLockTown = 'false',
oIsLockVillage = 'false',
oIsLockRoadSection = 'false',
oIsLockLane = 'false',
oIsLockAlley = 'false',
oIsLockArea = 'false',
oIsSameNumber_SubNumber = 'true',                #modify
oCanIgnoreVillage = 'true',                     #modify
oCanIgnoreNeighborhood = 'true',                #modify
oReturnMaxCount = '0'

browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(2) .frmInput").send_keys(oAPPId)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(3) .frmInput").send_keys(oAPIKey)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(4) .frmInput").send_keys(oAddress)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(5) .frmInput").send_keys(oSRS)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(6) .frmInput").send_keys(oFuzzyType)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(7) .frmInput").send_keys(oResultDataType)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(8) .frmInput").send_keys(oFuzzyBuffer)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(9) .frmInput").send_keys(oIsOnlyFullMatch)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(10) .frmInput").send_keys(oIsLockCounty)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(11) .frmInput").send_keys(oIsLockTown)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(12) .frmInput").send_keys(oIsLockVillage)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(13) .frmInput").send_keys(oIsLockRoadSection)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(14) .frmInput").send_keys(oIsLockLane)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(15) .frmInput").send_keys(oIsLockAlley)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(16) .frmInput").send_keys(oIsLockArea)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(17) .frmInput").send_keys(oIsSameNumber_SubNumber)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(18) .frmInput").send_keys(oCanIgnoreVillage)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(19) .frmInput").send_keys(oCanIgnoreNeighborhood)
browser.find_element(by=By.CSS_SELECTOR, value="tr:nth-child(20) .frmInput").send_keys(oReturnMaxCount)
time.sleep(random.randint(min_time, max_time) + abs(random.random()))

browser.find_element(by=By.CSS_SELECTOR, value='.button').click()

handles = browser.window_handles
print(handles)

browser.switch_to.window(browser.window_handles[1])

a = browser.find_element(by=By.CLASS_NAME, value="pretty-print")
data_context = json.loads(a.text.replace('<string xmlns="http://tempuri.org/">', '').replace('</string>', ''))
print(data_context)

with open('from_tgos.txt', mode='w', encoding='utf-8') as (f1):
    f1.write(md5)
    f1.write(delimiter)
    f1.write(data_context['Info'][0]['InAddress'])#.encode('utf8'))
    f1.write(delimiter)
    f1.write(data_context['AddressList'][0]['FULL_ADDR'])#.encode('utf8'))
    f1.write(delimiter)
    f1.write(data_context['AddressList'][0]['COUNTY'])#.encode('utf8'))
    f1.write(delimiter)
    f1.write(data_context['AddressList'][0]['TOWN'])#.encode('utf8'))
    f1.write(delimiter)
    f1.write(data_context['AddressList'][0]['VILLAGE'])#.encode('utf8'))
    f1.write(delimiter)
    f1.write(data_context['AddressList'][0]['NEIGHBORHOOD'])#.encode('utf8'))
    f1.write(delimiter)
    f1.write(data_context['AddressList'][0]['ROAD'])#.encode('utf8'))
    f1.write(delimiter)
    f1.write(data_context['AddressList'][0]['SECTION'])#.encode('utf8'))
    f1.write(delimiter)
    f1.write(data_context['AddressList'][0]['LANE'])#.encode('utf8'))
    f1.write(delimiter)
    f1.write(data_context['AddressList'][0]['ALLEY'])#.encode('utf8'))
    f1.write(delimiter)
    f1.write(data_context['AddressList'][0]['SUB_ALLEY'])#.encode('utf8'))
    f1.write(delimiter)
    f1.write(data_context['AddressList'][0]['TONG'])#.encode('utf8'))
    f1.write(delimiter)
    f1.write(data_context['AddressList'][0]['NUMBER'])#.encode('utf8'))
    f1.write(delimiter)
    f1.write(str(data_context['AddressList'][0]['X']))
    f1.write(delimiter)
    f1.write(str(data_context['AddressList'][0]['Y']))
    time.sleep(random.randint(min_time, max_time) + abs(random.random()))
    
browser.switch_to_window(handles[1]) 
browser.close()
browser.switch_to_window(handles[0]) 
browser.close()
